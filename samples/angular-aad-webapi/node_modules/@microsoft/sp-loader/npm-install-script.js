"use strict"

const path = require('path');
const fs = require('fs');

function resolve(packageName) {
  return path.dirname(require.resolve(packageName));
}

// Figure out where React is
let reactPath = resolve('react');
const reactPackage = require(path.join(reactPath, 'package.json'));
reactPath = path.join(reactPath, 'dist', 'react.js');

let reactDomPath = resolve('react-dom');
const reactDomPackage = require(path.join(reactDomPath, 'package.json'));
reactDomPath = path.join(reactDomPath, 'dist', 'react-dom.js');

const loaderPublicPath = path.join(__dirname, 'dist');

const reactRelativePath = path.relative(loaderPublicPath, reactPath);
const reactRelativeUrl = reactRelativePath.replace(/\\/g, '/');

const reactDomRelativePath = path.relative(loaderPublicPath, reactDomPath);
const reactDomRelativeUrl = reactDomRelativePath.replace(/\\/g, '/');

function fixLoaderBundle(distFile) {
  const loaderScriptPath = path.join(loaderPublicPath, distFile);
  let loaderScript = fs.readFileSync(loaderScriptPath, { encoding: 'utf-8' });
  loaderScript = loaderScript.replace(/__RELATIVE_REACT_PATH__/g, reactRelativeUrl)
                             .replace(/__RELATIVE_REACT_DOM_PATH__/g, reactDomRelativeUrl)
                             .replace(/__REACT_VERSION__/g, reactPackage.version)
                             .replace(/__REACT_DOM_VERSION__/g, reactDomPackage.version);
  fs.writeFileSync(loaderScriptPath, loaderScript);
}

fixLoaderBundle('sp-loader.js');
fixLoaderBundle('sp-loader_en-us.js');
